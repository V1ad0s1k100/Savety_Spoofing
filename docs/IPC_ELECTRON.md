# IPC связь между Electron.js и Python с использованием preload.js

## Общий принцип работы

Межпроцессное взаимодействие (IPC) между Electron и Python осуществляется через создание дочернего процесса Python и обмен сообщениями через стандартные потоки ввода-вывода с использованием промежуточного preload-скрипта для обеспечения безопасности.

## Архитектура решения

Система состоит из четырех основных компонентов:

1. **Основной процесс Electron** - создает окно браузера и управляет Python-процессом
2. **Preload-скрипт** - предоставляет безопасный API для рендерера
3. **Процесс рендерера** - пользовательский интерфейс приложения
4. **Python-процесс** - выполняет Python-код и обменивается сообщениями

## Поток данных

### Отправка сообщений в Python:

1. Рендерер вызывает API из preload-скрипта
2. Preload-скрипт пересылает сообщение в основной процесс
3. Основной процесс записывает сообщение в stdin Python-процесса

### Получение сообщений от Python:

1. Python-процесс выводит данные в stdout
2. Основной процесс Electron перехватывает вывод
3. Через IPC сообщение передается в preload-скрипт
4. Preload-скрипт вызывает callback-функцию в рендерере

## Ключевые особенности реализации

### Обработка ошибок:

1. Уровень основного процесса Electron (main.js)

- **Ошибки запуска Python-процесса**:

  - Проверка доступности Python в системе
  - Обработка ошибок spawn (ENOENT, EACCES)

- **Ошибки в работе дочернего процесса**:

  - Обработка stderr Python-процесса
  - Мониторинг неожиданного завершения (событие 'close')
  - Таймауты на выполнение операций

- **Ошибки IPC-канала**:
  - Проверка возможности записи в stdin
  - Обработка разрыва соединения

2. Уровень preload.js

- **Валидация данных**:

  - Проверка формата отправляемых сообщений
  - Фильтрация потенциально опасных команд

- **Обработка ошибок связи**:
  - Таймауты ожидания ответа
  - Проверка доступности каналов

3. Уровень рендерера (UI)

- **Обработка ошибок API**:

  - try/catch для вызовов electronAPI
  - Отображение пользовательских ошибок

- **Состояние соединения**:
  - Индикаторы активности/ошибок
  - Повторные попытки при сбоях

4. Уровень Python-скрипта

- **Обработка входных данных**:

  - Валидация полученных команд
  - try/except для опасных операций

- **Корректное завершение**:
  - Обработка сигналов прерывания
  - Закрытие ресурсов в finally

Критические места для обработки ошибок:

1. При запуске Python-процесса
2. При записи в stdin (проверка writable)
3. При чтении из stdout/stderr
4. При сериализации/десериализации сообщений
5. При передаче между процессами

### Безопасность

- Обязательное использование Context Isolation
- Запрет прямого доступа к Node.js из рендерера
- Ограниченный API через preload-скрипт

### Надежность

- Обработка ошибок в Python-процессе
- Контроль состояния дочернего процесса
- Корректное завершение процессов при закрытии приложения

### Производительность

- Буферизация сообщений при высокой частоте
- Минимизация накладных расходов IPC
- Эффективная сериализация данных
